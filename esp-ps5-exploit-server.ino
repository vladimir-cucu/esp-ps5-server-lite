#ifdef ENABLE_REDIRECT
#include <DNSServer.h>
#include <ESP8266WebServerSecure.h>
#else
#include <ESP8266WebServer.h>
#endif
#include <ESP8266WiFi.h>
#include <LittleFS.h>

#include "admin.h"
#include "config.h"
#include "exploit.h"
#include "payloads.h"

#ifdef ENABLE_REDIRECT
DNSServer dnsServer;
ESP8266WebServerSecure serverSecure(443);
#endif
ESP8266WebServer server(80);

String getContentType(const String path) {
  if (path.endsWith(".html") || path.endsWith("/")) return "text/html";
  else if (path.endsWith(".css")) return "text/css";
  else if (path.endsWith(".js")) return "application/javascript";
  else if (path.endsWith(".appcache")) return "text/cache-manifest";
  else if (path.endsWith(".elf") || path.endsWith(".bin")) return "application/octet-stream";
  return "text/plain";
}

void handlePROGMEMRequest(const String path, const uint8_t* data, const uint32_t dataSize) {
  server.on(path, HTTP_GET, [path, data, dataSize]() {
    server.sendHeader("Content-Encoding", "gzip");
    server.send(200, getContentType(path).c_str(), data, dataSize);
  });
}

void handleFSRequest(const String path) {
  server.on(path, HTTP_GET, [path]() {
    File file = LittleFS.open(path, "r");
    server.streamFile(file, getContentType(path));
    file.close();
  });
}

void startWiFiAP() {
  String ssid = ServerConfig::ssid, password = ServerConfig::password;
  WiFi.softAPConfig(ServerConfig::ip, ServerConfig::gateway, ServerConfig::subnet);
  File file = LittleFS.open(ServerConfig::wifiCredentialsPath, "r");
  if (file) {
    (ssid = file.readStringUntil('\n')).replace("\r", "");
    (password = file.readStringUntil('\n')).replace("\r", "");
  }
  file.close();
  WiFi.softAP(ssid, password);
}

#ifdef ENABLE_REDIRECT
void handleRedirectToExploit() {
  String redirectURL = "http://" + ServerConfig::ip.toString() + "/index.html";
  server.onNotFound([redirectURL]() {
    server.sendHeader("Location", redirectURL, true);
    server.send(301, "text/plain", "");
  });
  serverSecure.onNotFound([redirectURL]() {
    serverSecure.sendHeader("Location", redirectURL, true);
    serverSecure.send(301, "text/plain", "");
  });
}
#endif

void serveExploit() {
  handlePROGMEMRequest("/", umtx2_index_html, sizeof(umtx2_index_html));
  handlePROGMEMRequest("/index.html", umtx2_index_html, sizeof(umtx2_index_html));
  handleFSRequest("/cache.appcache");
  handlePROGMEMRequest("/custom_host_stuff.js", umtx2_custom_host_stuff_js, sizeof(umtx2_custom_host_stuff_js));
  handlePROGMEMRequest("/int64.js", umtx2_int64_js, sizeof(umtx2_int64_js));
  handlePROGMEMRequest("/main.css", umtx2_main_css, sizeof(umtx2_main_css));
  handlePROGMEMRequest("/main.js", umtx2_main_js, sizeof(umtx2_main_js));
  handleFSRequest("/payload_map.js");
  handlePROGMEMRequest("/rop.js", umtx2_rop_js, sizeof(umtx2_rop_js));
  handlePROGMEMRequest("/rop_slave.js", umtx2_rop_slave_js, sizeof(umtx2_rop_slave_js));
  handlePROGMEMRequest("/syscalls.js", umtx2_syscalls_js, sizeof(umtx2_syscalls_js));
  handlePROGMEMRequest("/umtx2.js", umtx2_umtx2_js, sizeof(umtx2_umtx2_js));
  handlePROGMEMRequest("/offsets/1.00.js", offsets_1_00_js, sizeof(offsets_1_00_js));
  handlePROGMEMRequest("/offsets/1.01.js", offsets_1_01_js, sizeof(offsets_1_01_js));
  handlePROGMEMRequest("/offsets/1.02.js", offsets_1_02_js, sizeof(offsets_1_02_js));
  handlePROGMEMRequest("/offsets/1.05.js", offsets_1_05_js, sizeof(offsets_1_05_js));
  handlePROGMEMRequest("/offsets/1.10.js", offsets_1_10_js, sizeof(offsets_1_10_js));
  handlePROGMEMRequest("/offsets/1.11.js", offsets_1_11_js, sizeof(offsets_1_11_js));
  handlePROGMEMRequest("/offsets/1.12.js", offsets_1_12_js, sizeof(offsets_1_12_js));
  handlePROGMEMRequest("/offsets/1.13.js", offsets_1_13_js, sizeof(offsets_1_13_js));
  handlePROGMEMRequest("/offsets/1.14.js", offsets_1_14_js, sizeof(offsets_1_14_js));
  handlePROGMEMRequest("/offsets/2.00.js", offsets_2_00_js, sizeof(offsets_2_00_js));
  handlePROGMEMRequest("/offsets/2.20.js", offsets_2_20_js, sizeof(offsets_2_20_js));
  handlePROGMEMRequest("/offsets/2.25.js", offsets_2_25_js, sizeof(offsets_2_25_js));
  handlePROGMEMRequest("/offsets/2.26.js", offsets_2_26_js, sizeof(offsets_2_26_js));
  handlePROGMEMRequest("/offsets/2.30.js", offsets_2_30_js, sizeof(offsets_2_30_js));
  handlePROGMEMRequest("/offsets/2.50.js", offsets_2_50_js, sizeof(offsets_2_50_js));
  handlePROGMEMRequest("/offsets/2.70.js", offsets_2_70_js, sizeof(offsets_2_70_js));
  handlePROGMEMRequest("/offsets/3.00.js", offsets_3_00_js, sizeof(offsets_3_00_js));
  handlePROGMEMRequest("/offsets/3.10.js", offsets_3_10_js, sizeof(offsets_3_10_js));
  handlePROGMEMRequest("/offsets/3.20.js", offsets_3_20_js, sizeof(offsets_3_20_js));
  handlePROGMEMRequest("/offsets/3.21.js", offsets_3_21_js, sizeof(offsets_3_21_js));
  handlePROGMEMRequest("/offsets/4.00.js", offsets_4_00_js, sizeof(offsets_4_00_js));
  handlePROGMEMRequest("/offsets/4.02.js", offsets_4_02_js, sizeof(offsets_4_02_js));
  handlePROGMEMRequest("/offsets/4.03.js", offsets_4_03_js, sizeof(offsets_4_03_js));
  handlePROGMEMRequest("/offsets/4.50.js", offsets_4_50_js, sizeof(offsets_4_50_js));
  handlePROGMEMRequest("/offsets/4.51.js", offsets_4_51_js, sizeof(offsets_4_51_js));
  handlePROGMEMRequest("/offsets/5.00.js", offsets_5_00_js, sizeof(offsets_5_00_js));
  handlePROGMEMRequest("/offsets/5.02.js", offsets_5_02_js, sizeof(offsets_5_02_js));
  handlePROGMEMRequest("/offsets/5.10.js", offsets_5_10_js, sizeof(offsets_5_10_js));
  handlePROGMEMRequest("/offsets/5.50.js", offsets_5_50_js, sizeof(offsets_5_50_js));
  handlePROGMEMRequest("/psfree/alert.js", psfree_alert_js, sizeof(psfree_alert_js));
  handlePROGMEMRequest("/psfree/config.js", psfree_config_js, sizeof(psfree_config_js));
  handlePROGMEMRequest("/psfree/psfree.js", psfree_psfree_js, sizeof(psfree_psfree_js));
  handlePROGMEMRequest("/psfree/module/chain.js", psfree_module_chain_js, sizeof(psfree_module_chain_js));
  handlePROGMEMRequest("/psfree/module/int64.js", psfree_module_int64_js, sizeof(psfree_module_int64_js));
  handlePROGMEMRequest("/psfree/module/mem.js", psfree_module_mem_js, sizeof(psfree_module_mem_js));
  handlePROGMEMRequest("/psfree/module/memtools.js", psfree_module_memtools_js, sizeof(psfree_module_memtools_js));
  handlePROGMEMRequest("/psfree/module/offset.js", psfree_module_offset_js, sizeof(psfree_module_offset_js));
  handlePROGMEMRequest("/psfree/module/rw.js", psfree_module_rw_js, sizeof(psfree_module_rw_js));
  handlePROGMEMRequest("/psfree/module/utils.js", psfree_module_utils_js, sizeof(psfree_module_utils_js));
}

void servePayloads() {
  handlePROGMEMRequest("/payloads/byepervisor.elf", payloads_byepervisor_elf, sizeof(payloads_byepervisor_elf));
  handlePROGMEMRequest("/payloads/elfldr.elf", payloads_elfldr_elf, sizeof(payloads_elfldr_elf));
  Dir payload = LittleFS.openDir("/payloads");
  while (payload.next()) {
    String payloadPath = "/payloads/" + payload.fileName();
    handleFSRequest(payloadPath);
  }
}

void serveAdminPage() {
  handlePROGMEMRequest("/admin.html", admin_admin_html, sizeof(admin_admin_html));
  server.on("/update-wifi-credentials", HTTP_POST, []() {
    if (!server.hasArg("ssid") || !server.hasArg("password")) return;
    String ssid = server.arg("ssid"), password = server.arg("password");
    File file = LittleFS.open(ServerConfig::wifiCredentialsPath, "w");
    file.println(ssid);
    file.println(password);
    file.close();
    server.send(200, "text/plain", "WiFi credentials have been updated. Rebooting ESP8266...");
    delay(500);
    WiFi.softAPdisconnect(true);
    delay(500);
    ESP.restart();
  });
}

void setup() {
  LittleFS.begin();
  startWiFiAP();
#ifdef ENABLE_REDIRECT
  dnsServer.start(53, "*", ServerConfig::ip);
  serverSecure.getServer().setRSACert(&ServerConfig::cert, &ServerConfig::key);
#endif

  serveExploit();
  servePayloads();
  serveAdminPage();

#ifdef ENABLE_REDIRECT
  handleRedirectToExploit();
  serverSecure.begin();
#endif
  server.begin();
}

void loop() {
#ifdef ENABLE_REDIRECT
  dnsServer.processNextRequest();
  serverSecure.handleClient();
#endif
  server.handleClient();
}
